<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cycling Dashboard</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/togeojson/0.16.0/togeojson.min.js"></script>

    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #1a1a1a; font-family: sans-serif; }
        #container { display: flex; flex-direction: column; height: 100vh; }
        #map { flex: 3; z-index: 1; }
        #chart-container { flex: 1; background: white; border-top: 3px solid #333; padding: 5px; position: relative; }
        
        #ui-overlay { position: absolute; top: 12px; left: 12px; z-index: 1000; display: flex; flex-direction: column; gap: 8px; }
        .btn { 
            background: rgba(255,255,255,0.9); border: none; padding: 10px 15px; 
            border-radius: 8px; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            font-size: 14px; cursor: pointer;
        }
        #recenter-btn { background: #3498db; color: white; display: none; }
        #status { color: white; position: absolute; bottom: 26%; left: 10px; z-index: 1000; font-size: 11px; text-shadow: 1px 1px 2px #000; }
    </style>
</head>
<body>

<div id="container">
    <div id="ui-overlay">
        <label class="btn">üìÇ Load KML <input type="file" id="kml-upload" accept=".kml" style="display:none"></label>
        <button class="btn" id="recenter-btn">üéØ Resume Following</button>
        <button class="btn" id="clear-btn" style="background: #e74c3c; color: white;">üóëÔ∏è Reset</button>
    </div>
    <div id="status">Waiting for GPS...</div>
    <div id="map"></div>
    <div id="chart-container"><canvas id="elevationChart"></canvas></div>
</div>

<script>
    let map, chart, userMarker, trailLine, kmlRouteLine;
    let routeGeoJson = null;
    let breadcrumbs = [];
    let isFollowing = true;
    const MILES_TO_METERS = 1609.34;

    function init() {
        // 1. Setup Map
        map = L.map('map', { zoomControl: false, tap: false }).setView([0, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png').addTo(map);

        userMarker = L.circleMarker([0,0], { color: '#2ecc71', fillColor: '#27ae60', fillOpacity: 1, radius: 9 }).addTo(map);
        trailLine = L.polyline([], { color: '#3498db', weight: 5, opacity: 0.7 }).addTo(map);

        // 2. Chart Setup
        chart = new Chart(document.getElementById('elevationChart'), {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    { label: 'Elevation', data: [], borderColor: '#27ae60', backgroundColor: 'rgba(39,174,96,0.1)', fill: true, pointRadius: 0, tension: 0.2 },
                    { label: 'You', data: [], pointRadius: 10, pointBackgroundColor: '#e74c3c', showLine: false }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: false }, scales: { x: { display: true }, y: { display: true } } }
        });

        // 3. Map Interaction logic
        map.on('movestart', (e) => { if (e.hard) return; isFollowing = false; document.getElementById('recenter-btn').style.display = 'block'; });
        document.getElementById('recenter-btn').onclick = () => { isFollowing = true; document.getElementById('recenter-btn').style.display = 'none'; };

        // 4. Persistence
        const saved = localStorage.getItem('cycling_kml_foss');
        navigator.geolocation.getCurrentPosition((pos) => {
            const loc = [pos.coords.latitude, pos.coords.longitude];
            if (saved) {
                loadKml(saved);
            } else {
                map.fitBounds(L.latLng(loc).toBounds(20 * MILES_TO_METERS));
            }
        });

        // 5. Handlers
        document.getElementById('kml-upload').onchange = (e) => {
            const reader = new FileReader();
            reader.onload = (ev) => { localStorage.setItem('cycling_kml_foss', ev.target.result); loadKml(ev.target.result); };
            reader.readAsText(e.target.files[0]);
        };
        document.getElementById('clear-btn').onclick = () => { localStorage.removeItem('cycling_kml_foss'); location.reload(); };

        startGPS();
    }

    function loadKml(xmlString) {
        const geojson = toGeoJSON.kml(new DOMParser().parseFromString(xmlString, "text/xml"));
        const line = geojson.features.find(f => f.geometry.type === 'LineString');
        if (!line) return;

        routeGeoJson = line;
        const coords = line.geometry.coordinates;
        let dist = 0, labels = [], elevs = [];

        coords.forEach((c, i) => {
            if (i > 0) dist += turf.distance(turf.point(coords[i-1]), turf.point(c));
            labels.push(dist.toFixed(2));
            elevs.push(c[2] || 0);
        });

        chart.data.labels = labels;
        chart.data.datasets[0].data = elevs;
        chart.update();

        if (kmlRouteLine) map.removeLayer(kmlRouteLine);
        kmlRouteLine = L.polyline(coords.map(c => [c[1], c[0]]), { color: '#000', weight: 3, opacity: 0.5, dashArray: '5, 8' }).addTo(map);
        map.fitBounds(kmlRouteLine.getBounds(), { padding: [30, 30] });
    }

    function startGPS() {
        navigator.geolocation.watchPosition((pos) => {
            const { latitude: lat, longitude: lng } = pos.coords;
            const now = Date.now();
            document.getElementById('status').innerText = `GPS Active: ${lat.toFixed(4)}, ${lng.toFixed(4)}`;

            userMarker.setLatLng([lat, lng]);
            if (isFollowing) map.panTo([lat, lng]);

            breadcrumbs.push({ lat, lng, time: now });
            breadcrumbs = breadcrumbs.filter(b => now - b.time < 300000);
            trailLine.setLatLngs(breadcrumbs.map(b => [b.lat, b.lng]));

            if (routeGeoJson) {
                const snapped = turf.nearestPointOnLine(routeGeoJson, turf.point([lng, lat]));
                chart.data.datasets[1].data = [{ x: snapped.properties.location.toFixed(2), y: snapped.geometry.coordinates[2] }];
                chart.update('none');
            }
        }, null, { enableHighAccuracy: true });
    }

    window.onload = init;
</script>
</body>
</html>
